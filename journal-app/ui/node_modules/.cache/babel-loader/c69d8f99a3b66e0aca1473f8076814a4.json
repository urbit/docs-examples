{"ast":null,"code":"import _toConsumableArray from\"/home/mike/proj/frontend/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _objectSpread from\"/home/mike/proj/frontend/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/home/mike/proj/frontend/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _classCallCheck from\"/home/mike/proj/frontend/ui/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/mike/proj/frontend/ui/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/home/mike/proj/frontend/ui/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/mike/proj/frontend/ui/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import _regeneratorRuntime from\"/home/mike/proj/frontend/ui/node_modules/@babel/runtime/regenerator/index.js\";import React,{Component}from'react';import Urbit from'@urbit/http-api';import'bootstrap/dist/css/bootstrap.min.css';import'react-day-picker/lib/style.css';import TextareaAutosize from'react-textarea-autosize';import Button from'react-bootstrap/Button';import Card from'react-bootstrap/Card';import Stack from'react-bootstrap/Stack';import Tab from'react-bootstrap/Tab';import Tabs from'react-bootstrap/Tabs';import ToastContainer from'react-bootstrap/ToastContainer';import Toast from'react-bootstrap/Toast';import Spinner from'react-bootstrap/Spinner';import CloseButton from'react-bootstrap/CloseButton';import Modal from'react-bootstrap/Modal';import DayPickerInput from'react-day-picker/DayPickerInput';import endOfDay from'date-fns/endOfDay';import startOfDay from'date-fns/startOfDay';import{BottomScrollListener}from'react-bottom-scroll-listener';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var App=/*#__PURE__*/function(_Component){_inherits(App,_Component);var _super=_createSuper(App);function App(){var _this;_classCallCheck(this,App);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={entries:[],drafts:{},newDraft:{},results:[],searchTime:null,searchStart:null,searchEnd:null,resultStart:null,resultEnd:null,latestUpdate:null,entryToDelete:null,status:null,errorCount:0,errors:new Map()};_this.init=function(){_this.getEntries().then(function(result){_this.handleUpdate(result);_this.setState({latestUpdate:result.time});_this.subscribe();},function(err){_this.setErrorMsg(\"Connection failed\");_this.setState({status:\"err\"});});};_this.reconnect=function(){window.urbit.reset();var latest=_this.state.latestUpdate;if(latest===null){_this.init();}else{_this.getUpdates().then(function(result){result.logs.map(function(e){return _this.handleUpdate(e);});_this.subscribe();},function(err){_this.setErrorMsg(\"Connection failed\");_this.setState({status:\"err\"});});}};_this.getUpdates=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var latest,since,path;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:latest=_this.state.latestUpdate;since=latest===null?Date.now():latest;path=\"/updates/since/\".concat(since);return _context.abrupt(\"return\",window.urbit.scry({app:\"journal\",path:path}));case 4:case\"end\":return _context.stop();}}},_callee);}));_this.getEntries=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var e,before,max,path;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:e=_this.state.entries;before=e.length===0?Date.now():e[e.length-1].id;max=10;path=\"/entries/before/\".concat(before,\"/\").concat(max);return _context2.abrupt(\"return\",window.urbit.scry({app:\"journal\",path:path}));case 5:case\"end\":return _context2.stop();}}},_callee2);}));_this.moreEntries=function(){_this.getEntries().then(function(result){_this.handleUpdate(result);},function(err){_this.setErrorMsg(\"Fetching more entries failed\");});};_this.subscribe=function(){try{window.urbit.subscribe({app:\"journal\",path:\"/updates\",event:_this.handleUpdate,err:function err(){return _this.setErrorMsg(\"Subscription rejected\");},quit:function quit(){return _this.setErrorMsg(\"Kicked from subscription\");}});}catch(_unused){_this.setErrorMsg(\"Subscription failed\");}};_this.delete=function(id){window.urbit.poke({app:\"journal\",mark:\"journal-action\",json:{\"del\":{\"id\":id}},onError:function onError(){return _this.setErrorMsg(\"Deletion rejected\");}});_this.setState({rmModalShow:false,entryToDelete:null});};_this.submitEdit=function(id,txt){if(txt!==null){window.urbit.poke({app:\"journal\",mark:\"journal-action\",json:{\"edit\":{\"id\":id,\"txt\":txt}},onError:function onError(){return _this.setErrorMsg(\"Edit rejected\");}});}else _this.cancelEdit(id);};_this.submitNew=function(id,txt){window.urbit.poke({app:\"journal\",mark:\"journal-action\",json:{\"add\":{\"id\":id,\"txt\":txt}},onSuccess:function onSuccess(){return _this.setState({newDraft:{}});},onError:function onError(){return _this.setErrorMsg(\"New entry rejected\");}});};_this.getSearch=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var _this$state,ss,se,lu,start,end,path;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_this$state=_this.state,ss=_this$state.searchStart,se=_this$state.searchEnd,lu=_this$state.latestUpdate;if(lu!==null&&ss!==null&&se!==null){start=ss.getTime();end=se.getTime();if(start<0)start=0;if(end<0)end=0;path=\"/entries/between/\".concat(start,\"/\").concat(end);window.urbit.scry({app:\"journal\",path:path}).then(function(result){_this.setState({searchTime:result.time,searchStart:null,searchEnd:null,resultStart:ss,resultEnd:se,results:result.entries});},function(err){_this.setErrorMsg(\"Search failed\");});}else{lu!==null&&_this.setErrorMsg(\"Searh failed\");}case 2:case\"end\":return _context3.stop();}}},_callee3);}));_this.spot=function(id,data){var low=0;var high=data.length;while(low<high){var mid=low+high>>>1;if(data[mid].id>id)low=mid+1;else high=mid;}return low;};_this.inSearch=function(id,time){var _this$state2=_this.state,searchTime=_this$state2.searchTime,resultStart=_this$state2.resultStart,resultEnd=_this$state2.resultEnd;return searchTime!==null&&time>=searchTime&&resultStart.getTime()<=id&&resultEnd.getTime()>=id;};_this.handleUpdate=function(upd){var _this$state3=_this.state,entries=_this$state3.entries,drafts=_this$state3.drafts,results=_this$state3.results,latestUpdate=_this$state3.latestUpdate;if(upd.time!==latestUpdate){if(\"entries\"in upd){_this.setState({entries:entries.concat(upd.entries)});}else if(\"add\"in upd){var time=upd.time,add=upd.add;var eInd=_this.spot(add.id,entries);var rInd=_this.spot(add.id,results);var toE=entries.length===0||add.id>entries[entries.length-1].id;var toR=_this.inSearch(add.id,time);toE&&entries.splice(eInd,0,add);toR&&results.splice(rInd,0,add);_this.setState(_objectSpread(_objectSpread(_objectSpread({},toE&&{entries:entries}),toR&&{results:results}),{},{latestUpdate:time}));}else if(\"edit\"in upd){var _time=upd.time,edit=upd.edit;var _eInd=entries.findIndex(function(e){return e.id===edit.id;});var _rInd=results.findIndex(function(e){return e.id===edit.id;});var _toE=_eInd!==-1;var _toR=_rInd!==-1&&_this.inSearch(edit.id,_time);if(_toE)entries[_eInd]=edit;if(_toR)results[_rInd]=edit;(_toE||_toR)&&delete drafts[edit.id];_this.setState(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},_toE&&{entries:entries}),_toR&&{results:results}),(_toE||_toR)&&{drafts:drafts}),{},{latestUpdate:_time}));}else if(\"del\"in upd){var _time2=upd.time,del=upd.del;var _eInd2=entries.findIndex(function(e){return e.id===del.id;});var _rInd2=results.findIndex(function(e){return e.id===del.id;});var _toE2=_eInd2!==-1;var _toR2=_this.inSearch(del.id,_time2)&&_rInd2!==-1;_toE2&&entries.splice(_eInd2,1);_toR2&&results.splice(_rInd2,1);(_toE2||_toR2)&&delete drafts[del.id];_this.setState(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},_toE2&&{entries:entries}),_toR2&&{results:results}),(_toE2||_toR2)&&{drafts:drafts}),{},{latestUpdate:_time2}));}}};_this.cancelEdit=function(id){var drafts=_this.state.drafts;delete drafts[id];_this.setState({drafts:drafts});};_this.saveDraft=function(id,text){var drafts=_this.state.drafts;drafts[id]=text;_this.setState({drafts:drafts});};_this.setEdit=function(id){var drafts=_this.state.drafts;if(!(id in drafts)){drafts[id]=null;_this.setState({drafts:drafts});}};_this.saveNew=function(id,txt){txt!==\"\"?_this.setState({newDraft:{id:id,txt:txt}}):_this.setState({newDraft:{}});};_this.newEntry=function(){var n=_this.state.newDraft;var isNew=Object.keys(n).length===0;var now=Date.now();return/*#__PURE__*/_jsxs(\"div\",{className:\"d-flex flex-column\",children:[/*#__PURE__*/_jsx(TextareaAutosize,{className:\"w-100 form-control\",placeholder:\"New journal entry\",value:isNew?\"\":n.txt,onChange:function onChange(e){return _this.saveNew(isNew?now:n.id,e.target.value);}}),!isNew&&/*#__PURE__*/_jsx(Button,{className:\"w-100 mt-3\",variant:\"outline-primary\",onClick:function onClick(){return _this.submitNew(n.id,n.txt);},children:\"Submit\"})]});};_this.closeRmModal=function(){_this.setState({entryToDelete:null});};_this.openRmModal=function(id){_this.setState({entryToDelete:id});};_this.rmModal=function(){var id=_this.state.entryToDelete;if(id!==null){return/*#__PURE__*/_jsxs(Modal,{size:\"lg\",centered:true,show:id!==null,onHide:function onHide(){return _this.closeRmModal();},children:[/*#__PURE__*/_jsx(Modal.Header,{closeButton:true,children:/*#__PURE__*/_jsx(Modal.Title,{children:\"Confirm Delete\"})}),/*#__PURE__*/_jsx(Modal.Body,{children:\"Are you sure you want to delete this journal entry?\"}),/*#__PURE__*/_jsx(Modal.Footer,{children:/*#__PURE__*/_jsx(Button,{variant:\"outline-danger\",onClick:function onClick(){return _this.delete(id);},children:\"Delete\"})})]});}};_this.editBox=function(id,txt,draft){return/*#__PURE__*/_jsx(TextareaAutosize,{className:\"w-100 form-control\",value:draft===null?txt:draft,onChange:function onChange(e){return _this.saveDraft(id,e.target.value);}});};_this.printEntry=function(_ref4){var id=_ref4.id,txt=_ref4.txt;var drafts=_this.state.drafts;var edit=(id in drafts);var draft=id in drafts?drafts[id]:null;var reg=/(?:\\r?\\n[ \\t]*){2,}(?!\\s*$)/;var d=new Date(id);return/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(Card.Header,{className:\"fs-4 d-flex align-items-center justify-content-between\",children:[d.toLocaleString(),/*#__PURE__*/_jsx(CloseButton,{className:\"fs-6\",onClick:function onClick(){return edit?_this.cancelEdit(id):_this.openRmModal(id);}})]}),/*#__PURE__*/_jsx(Card.Body,{onClick:function onClick(){return _this.setEdit(id);},children:edit?_this.editBox(id,txt,draft):txt.split(reg).map(function(e,ind){return/*#__PURE__*/_jsx(\"p\",{children:e},ind);})}),edit&&/*#__PURE__*/_jsx(Button,{variant:\"outline-primary\",className:\"mx-3 mb-3\",onClick:function onClick(){return _this.submitEdit(id,draft);},children:\"Submit\"})]},id);};_this.setSearchStart=function(when){if(when instanceof Date&&!isNaN(when)){var date=startOfDay(when);_this.setState({searchStart:date});}else _this.setState({searchStart:null});};_this.setSearchEnd=function(when){if(when instanceof Date&&!isNaN(when)){var date=endOfDay(when);_this.setState({searchEnd:date});}else _this.setState({searchEnd:null});};_this.searcher=function(){var _this$state4=_this.state,ss=_this$state4.searchStart,se=_this$state4.searchEnd,rs=_this$state4.resultStart,re=_this$state4.resultEnd;return/*#__PURE__*/_jsxs(Stack,{gap:5,children:[/*#__PURE__*/_jsxs(\"div\",{className:\"d-flex justify-content-between\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"me-2 d-flex justify-content-start align-items-center flex-wrap\",children:[/*#__PURE__*/_jsx(DayPickerInput,{value:ss,placeholder:\"FROM  YYYY-M-D\",onDayChange:function onDayChange(day){return _this.setSearchStart(day);},style:{margin:\"5px 5px 5px 0\"}}),/*#__PURE__*/_jsx(DayPickerInput,{value:se,placeholder:\"TO  YYYY-M-D\",onDayChange:function onDayChange(day){return _this.setSearchEnd(day);},style:{margin:\"5px 5px 5px 0\"}})]}),/*#__PURE__*/_jsx(Button,{className:\"w-20\",variant:ss===null||se===null?\"outline-secondary\":\"outline-primary\",disabled:ss===null||se===null,onClick:function onClick(){return _this.getSearch();},children:\"Search\"})]}),rs!==null&&re!==null&&/*#__PURE__*/_jsxs(\"div\",{className:\"fs-4\",children:[\"Results for \",rs.toLocaleDateString(),\" to \",re.toLocaleDateString()]})]});};_this.setErrorMsg=function(msg){var _this$state5=_this.state,errors=_this$state5.errors,errorCount=_this$state5.errorCount;var id=errorCount+1;_this.setState({errors:errors.set(id,msg),errorCount:id});};_this.rmErrorMsg=function(id){var errors=_this.state.errors;errors.delete(id);_this.setState({errors:errors});};_this.errorMsg=function(id,msg){return/*#__PURE__*/_jsx(Toast,{className:\"ms-auto\",onClose:function onClose(){return _this.rmErrorMsg(id);},show:true,delay:3000,autohide:true,style:{width:\"fit-content\"},children:/*#__PURE__*/_jsx(Toast.Header,{className:\"d-flex justify-content-between\",children:msg})},id);};_this.status=function(){var _this$state6=_this.state,status=_this$state6.status,errors=_this$state6.errors;return/*#__PURE__*/_jsxs(ToastContainer,{style:{position:\"sticky\",bottom:0,width:\"100%\",zIndex:50},children:[_toConsumableArray(errors).map(function(e){return _this.errorMsg(e[0],e[1]);}),/*#__PURE__*/_jsx(Toast,{bg:status===\"try\"?\"warning\":\"danger\",className:\"w-100\",show:status===\"try\"||status===\"err\",children:/*#__PURE__*/_jsx(Toast.Body,{className:\"d-flex justify-content-center align-items-center\",onClick:status===\"err\"?function(){return _this.reconnect();}:null,role:status===\"err\"?\"button\":undefined,children:/*#__PURE__*/_jsxs(\"strong\",{style:{color:\"white\"},children:[status===\"try\"&&/*#__PURE__*/_jsx(Spinner,{animation:\"border\",size:\"sm\",className:\"me-1\"}),status===\"try\"&&\"Reconnecting\",status===\"err\"&&\"Reconnect\"]})})})]});};return _this;}_createClass(App,[{key:\"componentDidMount\",value:function componentDidMount(){var _this2=this;window.urbit=new Urbit(\"\");window.urbit.ship=window.ship;window.urbit.onOpen=function(){return _this2.setState({status:\"con\"});};window.urbit.onRetry=function(){return _this2.setState({status:\"try\"});};window.urbit.onError=function(err){return _this2.setState({status:\"err\"});};this.init();}},{key:\"render\",value:function render(){var _this3=this;return/*#__PURE__*/_jsxs(React.Fragment,{children:[this.rmModal(),/*#__PURE__*/_jsx(\"div\",{className:\"m-3 d-flex justify-content-center\",children:/*#__PURE__*/_jsxs(Card,{style:{maxWidth:\"50rem\",width:\"100%\"},children:[/*#__PURE__*/_jsxs(Tabs,{defaultActiveKey:\"journal\",className:\"fs-2\",children:[/*#__PURE__*/_jsx(Tab,{eventKey:\"journal\",title:\"Journal\",children:/*#__PURE__*/_jsx(BottomScrollListener,{onBottom:function onBottom(){return _this3.moreEntries();},children:function children(scrollRef){return/*#__PURE__*/_jsxs(Stack,{gap:5,className:\"m-3 d-flex\",children:[_this3.newEntry(),_this3.state.entries.map(function(e){return _this3.printEntry(e);})]});}})}),/*#__PURE__*/_jsx(Tab,{eventKey:\"search\",title:\"Search\",children:/*#__PURE__*/_jsxs(Stack,{gap:5,className:\"m-3 d-flex\",children:[this.searcher(),this.state.results.map(function(e){return _this3.printEntry(e);})]})})]}),this.status()]})})]});}}]);return App;}(Component);export default App;","map":null,"metadata":{},"sourceType":"module"}